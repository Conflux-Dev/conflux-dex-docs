<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>The Shuttleflow Smart Contracts Design and Implementation - Conflux DEX Documentation</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "The Shuttleflow Smart Contracts Design and Implementation";
    var mkdocs_page_input_path = "shuttleflow\\smart_contract.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> Conflux DEX Documentation</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="../..">Welcome to Conflux DEX</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">MatchFlow</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../matchflow/">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../../matchflow/ws/">WebSocket API</a>
                </li>
                <li class="">
                    
    <a class="" href="../../matchflow/eip712/">EIP712 Signature</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">ShuttleFlow</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../">Introduction</a>
                </li>
                <li class="">
                    
    <a class="" href="../json_rpc/">JSON RPC</a>
                </li>
                <li class="">
                    
    <a class="" href="../sdk/">Conflux Crosschain SDK</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">Conflux DEX Documentation</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
    
    <li>The Shuttleflow Smart Contracts Design and Implementation</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="the-shuttleflow-smart-contracts-design-and-implementation">The Shuttleflow Smart Contracts Design and Implementation</h1>
<h2 id="design-goals">Design Goals</h2>
<p>The Shuttleflow smart contracts have following design goals:</p>
<ol>
<li>Support atomic mapping between Conflux cToken and cross chain assets including BTC, ETH and USDT.</li>
<li>Maintain the membership and authority of custodian alliance.</li>
<li>Pausable and upgradable, data migration.</li>
</ol>
<h2 id="components-on-conflux">Components (on Conflux)</h2>
<h3 id="custodiancore">CustodianCore</h3>
<p><code>CustodianCore</code> (contracts/core/CustodianCore.sol) is the main contract of custodian 
alliance on Conflux chain. It maintains the information of custodian members and configurations for 
custodian nodes, including:
* Custodian member's address/public key of different chain
* The address of all cTokens and their binding CRC-L address
* The upper/lower bounds of custodian alliance's bitcoin hot wallet
* The withdraw operation fee for bitcoin
* Processed user mint requests (indexed by payment transaction id on other block chain)</p>
<p>Ownership and authorities: 
* At this point, the owner of CustodianCore is Conflux admin, who is enabled to modify 
custodian node configurations and custodian membership.
* CustodianCore is the owner of all cToken so only it has the authority to mint cTokens.</p>
<p>Core Functions: </p>
<pre><code class="solidity">function mint(string calldata token, 
    address to, 
    uint amount, 
    string calldata tx_id, 
    bytes calldata signatures
) external onlyCustodian whenNotPaused;
</code></pre>

<p>Mint cToken for a user and then send the minted cToken to its binding CRC-L 
contract with default operator authority, trigger the callback of CRC-L contract and CRC-L
 will mint corresponding amount CRC-L token for user. This functions needs over 2/3 signatures
  from current custodian members.</p>
<pre><code class="solidity">function btcHotToCold(
        uint256 nonce,
        uint256 btc_cold_balance,
        bytes memory signatures
) public onlyCustodian whenNotPaused
</code></pre>

<p>This function will be called periodically by custodian nodes. It 
checks if the balance of custodian alliance's bitcoin hot wallet is larger than the 
upper bound and computes the amount of bitcoin they need to transfer to cold wallet.
 This functions needs over 2/3 signatures from current custodian members.</p>
<h3 id="tokenbase">TokenBase</h3>
<p><code>TokenBase</code> (contracts/token/TokenBase.sol) is the cross chain token contract (cToken).
 It is a ERC777 standard token.</p>
<p>Owership and autorities:
* Owner of cToken is initially who deployed it (Conflux admin), then its owner will transfer 
the ownership to CustodianCore contract. Only owner of the contract is able to mint cToken.
* Only pausers are able to pause/unpause the cToken contract. Initially, the pauser 
of cToken is Conflux admin, the pauser can add other pausers.</p>
<p>Core Functions:</p>
<p>TokenBase inherited from a pausable ERC777 contract, besides ERC777 standard functions, it also 
implemented following functions for cross chain:</p>
<pre><code class="solidity">function mint(
    address account,
    uint256 amount,
    string memory tx_id
) public onlyOwner whenNotPaused returns (bool);
</code></pre>

<p>Owner authority required. Mint tokens for user. Emits <code>Minted(address indexed toAddress, uint256 indexed amount, string tx_id)</code> event,
 the custodian nodes listen to this event and know a mint request from user is done.</p>
<pre><code class="solidity">function burn(
    address useraddr,
    uint256 amount,
    string memory addr
) public whenNotPaused returns (bool);
</code></pre>

<p>Burn cToken from sender's address, Emits <code>Burnt(uint256 indexed amount, string toAddress, address indexed fromAddress)</code>
event, the custodian nodes listen to this event and will withdraw cross chain assets to <code>toAddress</code>, which is a bitcoin/eth address.</p>
<h2 id="components-on-ethereum">Components (on Ethereum)</h2>
<h3 id="ethfactory">EthFactory</h3>
<p>Similar to <code>CustodianCore</code>, <code>EthFactory</code> (contracts/factory/EthFactory.sol) is the main contract of custodian 
alliance on Ethereum chain. It maintains the information of custodian members and configurations for 
custodian nodes, including:
* Custodian member's ethereum address
* The address of all supported erc20 tokens in Shuttleflow (USDT for now)
* The upper/lower bounds of custodian alliance's eth&amp;erc20 hot wallet
* The withdraw operation fee for eth/erc20
* Processed user mint requests (indexed by withdraw transaction id on Conflux)
Ownership and authorities: 
* At this point, the owner of EthFactory is Conflux admin, who is enabled to modify 
custodian node configurations and custodian membership.
* CustodianCore is the owner of all cToken so only it has the authority to mint cTokens.</p>
<p>Core Functions:</p>
<pre><code class="solidity">function burn(
    address payable toAddress,
    uint amount,
    string memory tx_id,     
    bytes memory signatures
) public onlyCustodian onlyAlive;
</code></pre>

<p>Owner authority required. Withdraw eth/erc20 token to user's address. This functions needs over 2/3 signatures from current custodian members.</p>
<pre><code class="solidity">function transferHotToCold(
    uint256 nonce,
    bytes memory signatures
) public onlyCustodian onlyAlive;
</code></pre>

<p>Will be called by custodian node periodically. Automatically transfer 
eth/erc20 token from hot wallet to cold wallet (both maintained by variables in EthFactory) 
if hot wallet balance is larger than upper bound. This functions needs over 2/3 signatures from current custodian members.</p>
<pre><code class="solidity">function transferColdToHot(
    string memory token,
    uint256 amount,
    uint256 nonce,
    bytes memory signatures
) public onlyCustodian onlyAlive;
</code></pre>

<p>Transfer specified amount of eth/erc20 token from cold wallet to hot wallet. 
This functions needs over 2/3 signatures from current custodian members using their cold wallet private key.</p>
<h3 id="receivewallet">ReceiveWallet</h3>
<p><code>ReceiveWallet</code>(or payment wallet) (contracts/factory/ReceiveWallet.sol) is the contract of user payment wallet (in other
 words, the receive wallet for custodian alliance). The receive wallet can only transfer eth/erc20 token 
 to the address of EthFactory, which is initialized when receive wallet contract construction and can not
 be modified in future. </p>
<p>Core Functions:</p>
<pre><code class="solidity">function retrieve() public;
</code></pre>

<p>Transfer all eth to EthFactory contract.</p>
<pre><code class="solidity">function retrieveToken(address token) public;
</code></pre>

<p>Transfer all erc20 token to EthFactory contract.</p>
<h3 id="create2factory">Create2Factory</h3>
<p><code>Create2Factory</code> (contracts/factory/Create2Factory.sol) is the generator of user payment wallet. 
It can calculate the address of payment wallet of a specific user conflux address before the 
payment wallet contract is really deployed.</p>
<p>This contract enable the custodian alliance provide the payment wallet address to user and 
deploy the payment wallet contract after they received at least one payment from user. </p>
              
            </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
      <p>Copyright © 2020 Conflux. All Rights Reserved.</p>
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
